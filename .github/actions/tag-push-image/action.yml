name: "Tag and Push Docker Image"
description: "Tag and Push Docker Image"
inputs:
  image:
    description: "image name"
    required: true
  tags:
    description: "image tags"
    required: true
  artifact:
    description: "artifact name"
    required: true
  GITHUB_TOKEN:
    description: "github token (tag)"
    required: true

runs:
  using: "composite"
  steps:
    - name: Download Image from Artifact
      if: ${{ inputs.artifact }}
      id: load-image
      uses: draftm0de/kernel.deployment/.github/actions/download-image@main
      with:
        image: ${{ inputs.image }}
        artifact: ${{ inputs.artifact }}

    - name: Tag And Push Docker Image
      shell: bash
      run: |
        echo "::notice:: Tagging And Pushing Docker Image..."       
        source="${{ inputs.image }}:latest"
        if [ -n "${{ steps.load-image.outputs.image }}" ]; then
          source="${{ steps.load-image.outputs.image }}"
        fi 
        echo "::notice:: > source: $source"
        
        tags="${{ inputs.tags }}"
        for tag in $tags; do        
          target="${{ inputs.image }}:${tag}"
          echo "::notice:: > tag as: $target"
          
          docker tag $source $target
          echo "::notice:: image tagged"
          
          docker push $target
          echo "::notice:: image pushed"
        done
        
        echo "::notice:: Image tagged and pushed..."

    - name: Authenticate With GitHub
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.GITHUB_TOKEN }}
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"             

    - name: Tag Git Commit
      shell: bash
      run: |
        echo "::notice:: Tagging Commit..."     
        tags="${{ inputs.tags }}"
        for tag in $tags; do
          echo "::notice:: > tags: $tags"
        done
        echo "::notice:: Commit tagged..."
